<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Banking App — Demo</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f6f9;color:#102a43;margin:0;padding:0}
  header{background:#0b3d91;color:#fff;padding:18px}
  .wrap{max-width:960px;margin:18px auto;padding:18px}
  .card{background:#fff;border-radius:8px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(2,6,23,0.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1}
  label{display:block;font-size:13px;color:#334e68;margin-bottom:6px}
  input,select{width:100%;padding:8px;border:1px solid #d9e2ec;border-radius:6px}
  button{background:#0b3d91;color:#fff;padding:10px 12px;border:none;border-radius:6px;cursor:pointer}
  .muted{color:#617d98;font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef3f8;text-align:left}
  .small{font-size:13px;color:#617d98}
</style>
</head>
<body>
<header><div style="max-width:960px;margin:0 auto">Banking App Demo — Frontend</div></header>
<div class="wrap">
  <div class="card">
    <h3>Connection</h3>
    <p class="muted small">Set backend location in the script (API_BASE). For local testing use <code>http://localhost:8000</code>. After deploying backend, set its public URL.</p>
    <div class="row">
      <div class="col">
        <label>API Base (for testing change if needed)</label>
        <input id="apiBaseInput" value="http://localhost:8000">
      </div>
      <div class="col" style="flex:0 0 220px;display:flex;align-items:flex-end">
        <button id="saveApi">Save</button>
      </div>
    </div>
  </div>

  <div class="card" id="authCard">
    <h3>Register / Login</h3>
    <div class="row">
      <div class="col">
        <label>Username</label><input id="username">
      </div>
      <div class="col">
        <label>Password</label><input id="password" type="password">
      </div>
      <div class="col">
        <label>Full name (register)</label><input id="fullname">
      </div>
    </div>
    <div style="margin-top:10px" class="actions">
      <button id="btnRegister">Register</button>
      <button id="btnLogin">Login</button>
      <span id="authMsg" class="small muted"></span>
    </div>
  </div>

  <div class="card" id="dashboard" style="display:none">
    <h3>Dashboard — <span id="userName"></span></h3>
    <div class="row">
      <div class="col">
        <div class="card">
          <h4>Accounts</h4>
          <div id="accountsList" class="small muted">loading...</div>
        </div>

        <div class="card">
          <h4>Savings</h4>
          <label>Select Account No</label>
          <select id="savingsSelect"></select>
          <label>Amount</label><input id="savingsAmount" value="100">
          <div style="margin-top:8px" class="actions">
            <button id="depositBtn">Deposit</button>
            <button id="withdrawBtn">Withdraw</button>
            <span id="savingsMsg" class="small muted"></span>
          </div>
        </div>

        <div class="card">
          <h4>Open FD</h4>
          <label>Principal</label><input id="fdPrincipal" value="1000">
          <label>Months</label><input id="fdMonths" value="12">
          <label>Annual rate (%)</label><input id="fdRate" value="5">
          <div style="margin-top:8px" class="actions">
            <button id="openFdBtn">Open FD</button>
            <span id="fdMsg" class="small muted"></span>
          </div>
        </div>

        <div class="card">
          <h4>Apply Loan</h4>
          <label>Principal</label><input id="loanPrincipal" value="5000">
          <label>Annual rate (%)</label><input id="loanRate" value="7.5">
          <label>Months</label><input id="loanMonths" value="12">
          <div style="margin-top:8px" class="actions">
            <button id="applyLoanBtn">Apply Loan</button>
            <span id="loanMsg" class="small muted"></span>
          </div>
        </div>

      </div>

      <div class="col" style="flex:0 0 360px">
        <div class="card">
          <h4>Cards</h4>
          <label>Issue Type</label>
          <select id="cardType"><option value="debit">Debit</option><option value="credit">Credit</option></select>
          <label>Linked Savings Account (for Debit) / Limit (for Credit)</label>
          <input id="cardParam" placeholder="AccountNo or limit">
          <div style="margin-top:8px" class="actions">
            <button id="issueCardBtn">Issue Card</button>
            <span id="cardMsg" class="small muted"></span>
          </div>

          <hr>

          <h4>Manage Card</h4>
          <label>Card Account No</label>
          <input id="cardAccountNo">
          <label>Amount</label><input id="cardAmount" value="100">
          <div style="margin-top:8px" class="actions">
            <button id="cardChargeBtn">Charge</button>
            <button id="cardPayBtn">Pay</button>
            <button id="cardMinDueBtn">Min Due</button>
            <span id="cardActionMsg" class="small muted"></span>
          </div>
          <div style="margin-top:10px" id="cardInfo" class="small muted"></div>
        </div>

        <div class="card">
          <h4>Raw API</h4>
          <p class="small muted">For debugging you can open developer console (F12) and view requests/responses.</p>
          <button id="refreshBtn">Refresh Accounts</button>
          <button id="logoutBtn">Logout</button>
        </div>

      </div>
    </div>
  </div>

  <div id="log" class="card" style="display:none">
    <h4>Console</h4>
    <pre id="logBox" style="height:160px;overflow:auto"></pre>
  </div>
</div>

<script>
/*
  Frontend script for Banking App.
  - Edit API_BASE below to point to your running backend (http://localhost:8000 or deployed URL)
  - This frontend uses only standard web APIs.
*/
let API_BASE = localStorage.getItem('API_BASE') || 'http://localhost:8000';

document.getElementById('apiBaseInput').value = API_BASE;
document.getElementById('saveApi').onclick = () => {
  API_BASE = document.getElementById('apiBaseInput').value.trim();
  localStorage.setItem('API_BASE', API_BASE);
  alert('Saved API base: ' + API_BASE);
};

const el = id => document.getElementById(id);
const log = (s) => { el('log').style.display='block'; el('logBox').textContent += s + "\\n"; el('logBox').scrollTop = el('logBox').scrollHeight; };

let token = null;
let usernameGlobal = null;

async function post(path, data) {
  const url = API_BASE + path;
  const body = new URLSearchParams(data);
  const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body });
  const text = await resp.text();
  try { return JSON.parse(text); } catch(e){ return {ok:false, raw:text}; }
}

async function getJson(path, params={}) {
  const url = new URL(API_BASE + path);
  Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
  const resp = await fetch(url, { method:'GET' });
  return resp.json();
}

el('btnRegister').onclick = async () => {
  const u = el('username').value.trim(), p = el('password').value.trim(), name = el('fullname').value.trim() || u;
  const r = await post('/register', {username:u, password:p, name:name});
  el('authMsg').textContent = JSON.stringify(r);
  log('REGISTER: '+JSON.stringify(r));
};

el('btnLogin').onclick = async () => {
  const u = el('username').value.trim(), p = el('password').value.trim();
  const r = await post('/login', {username:u, password:p});
  log('LOGIN: '+JSON.stringify(r));
  if (r.ok) {
    token = r.token;
    usernameGlobal = r.name;
    el('userName').textContent = usernameGlobal;
    el('authCard').style.display='none';
    el('dashboard').style.display='block';
    el('log').style.display='block';
    await refreshAccounts();
  } else {
    el('authMsg').textContent = r.error || 'Login failed';
  }
};

el('refreshBtn').onclick = refreshAccounts;
async function refreshAccounts() {
  if (!token) return;
  const j = await getJson('/accounts', { token: token });
  log('ACCOUNTS: '+JSON.stringify(j));
  if (!j.ok) return;
  const list = j.accounts || [];
  el('accountsList').innerHTML = list.map(a => `${a.accountNo} (${a.type}${a.balance? ' - ' + a.balance: (a.principal? ' - principal ' + a.principal : '')})`).join('<br>');
  // populate savings select
  const savings = list.filter(a=>a.type==='SavingsAccount');
  const sel = el('savingsSelect'); sel.innerHTML='';
  savings.forEach(s=>{ let o=document.createElement('option'); o.value=s.accountNo; o.textContent=s.accountNo + ' — ' + (s.balance||0); sel.appendChild(o); });
}

el('depositBtn').onclick = async () => {
  const acc = el('savingsSelect').value, amt = el('savingsAmount').value;
  const r = await post('/savings/deposit', { token: token, accountNo: acc, amount: amt });
  el('savingsMsg').textContent = JSON.stringify(r);
  log('DEPOSIT: '+JSON.stringify(r));
  await refreshAccounts();
};

el('withdrawBtn').onclick = async () => {
  const acc = el('savingsSelect').value, amt = el('savingsAmount').value;
  const r = await post('/savings/withdraw', { token: token, accountNo: acc, amount: amt });
  el('savingsMsg').textContent = JSON.stringify(r);
  log('WITHDRAW: '+JSON.stringify(r));
  await refreshAccounts();
};

el('openFdBtn').onclick = async () => {
  const principal = el('fdPrincipal').value, months = el('fdMonths').value, rate = el('fdRate').value;
  const r = await post('/fd/create', { token: token, principal: principal, months: months, rate: rate });
  el('fdMsg').textContent = JSON.stringify(r);
  log('FD CREATE: '+JSON.stringify(r));
  await refreshAccounts();
};

el('applyLoanBtn').onclick = async () => {
  const p = el('loanPrincipal').value, rate = el('loanRate').value, months = el('loanMonths').value;
  const r = await post('/loan/apply', { token: token, principal: p, rate: rate, months: months });
  el('loanMsg').textContent = JSON.stringify(r);
  log('LOAN APPLY: '+JSON.stringify(r));
  await refreshAccounts();
};

el('issueCardBtn').onclick = async () => {
  const type = el('cardType').value, param = el('cardParam').value.trim();
  const data = { token: token, type: type };
  if (type==='debit') data.linked = param;
  else data.limit = param;
  const r = await post('/card/issue', data);
  el('cardMsg').textContent = JSON.stringify(r);
  log('CARD ISSUE: '+JSON.stringify(r));
  await refreshAccounts();
};

el('cardChargeBtn').onclick = async () => {
  const acc = el('cardAccountNo').value.trim(), amt = el('cardAmount').value;
  const r = await post('/card/charge', { token: token, accountNo: acc, amount: amt });
  el('cardActionMsg').textContent = JSON.stringify(r);
  log('CARD CHARGE: '+JSON.stringify(r));
  await refreshAccounts();
};

el('cardPayBtn').onclick = async () => {
  const acc = el('cardAccountNo').value.trim(), amt = el('cardAmount').value;
  const r = await post('/card/pay', { token: token, accountNo: acc, amount: amt });
  el('cardActionMsg').textContent = JSON.stringify(r);
  log('CARD PAY: '+JSON.stringify(r));
  await refreshAccounts();
};

el('cardMinDueBtn').onclick = async () => {
  const acc = el('cardAccountNo').value.trim();
  const r = await getJson('/credit/mindue', { token: token, accountNo: acc });
  el('cardInfo').textContent = JSON.stringify(r);
  log('CARD MIN DUE: '+JSON.stringify(r));
};

el('logoutBtn').onclick = () => { token=null; usernameGlobal=null; el('dashboard').style.display='none'; el('authCard').style.display='block'; el('log').style.display='none'; el('authMsg').textContent='Logged out'; };

window.onload = () => {
  // if API_BASE saved in localStorage update variable
  const stored = localStorage.getItem('API_BASE');
  if (stored) API_BASE = stored;
  el('apiBaseInput').value = API_BASE;
};
</script>
</body>
</html>
